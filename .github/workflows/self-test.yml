name: Git-Storyteller Self-Test

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type'
        required: true
        default: 'analyze'
        type: choice
        options:
          - analyze
          - visual
          - full

  push:
    branches: [feature/*, develop]
    paths:
      - 'src/git_storyteller/**'
      - 'README.md'

permissions:
  contents: read

jobs:
  self-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Test 1: Analyze Repository
        if: github.event.inputs.test_type != 'visual' || github.event.inputs.test_type == ''
        run: |
          echo "ðŸ” Testing Git-Storyteller on itself..."
          echo ""
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
          echo ""
          echo "Running analysis..."
          python -c "
import sys
sys.path.insert(0, 'src')
from git_storyteller.core.git_analyzer import GitAnalyzer

analyzer = GitAnalyzer()
impact = analyzer.analyze('.', ref='HEAD', is_remote=False)

print(f'âœ… Repository: {impact.name}')
print(f'âœ… Description: {impact.description}')
print(f'âœ… Total Commits: {impact.total_commits}')
print(f'âœ… Recent Changes: {len(impact.recent_changes)}')
print('')
print('Marketing Hooks:')
for hook in impact.marketing_hooks[:3]:
    print(f'  â€¢ {hook}')
"
          echo ""
          echo "âœ… Analysis test passed!"

      - name: Test 2: Visual Template
        if: github.event.inputs.test_type == 'visual' || github.event.inputs.test_type == 'full' || github.event.inputs.test_type == ''
        run: |
          echo "ðŸŽ¨ Testing visual rendering..."
          echo ""
          python -c "
import sys
import asyncio
sys.path.insert(0, 'src')
from git_storyteller.core.visual_engine import VisualEngine

async def test_visual():
    engine = VisualEngine()

    # Test data
    data = {
        'repo_name': 'git-storyteller',
        'description': 'Autonomous marketing agent for developers',
        'total_commits': 100,
        'recent_count': 5,
        'marketing_hooks': [
            'ðŸš€ Just shipped a new feature',
            'ðŸ› Fixed critical bugs',
            'âš¡ Performance improvements'
        ],
        'visual_highlights': []
    }

    # Render Bento-Metrics template
    result = await engine.render_template(
        template_name='bento_metrics',
        data=data,
        commit_hash='test123',
        output_path=None
    )

    if result['success']:
        print('âœ… Visual rendering test passed!')
        print(f'âœ… Template: {result[\"template_used\"]}')
        print(f'âœ… Image size: {result[\"image_size\"]} bytes')
    else:
        print(f'âŒ Visual rendering failed: {result.get(\"error\")}')
        sys.exit(1)

asyncio.run(test_visual())
"
          echo ""
          echo "âœ… Visual test passed!"

      - name: Test 3: Generate Marketing Content
        if: github.event.inputs.test_type == 'full' || github.event.inputs.test_type == ''
        run: |
          echo "ðŸ“ Testing content generation..."
          echo ""
          python -c "
import sys
sys.path.insert(0, 'src')
from git_storyteller.core.git_analyzer import GitAnalyzer

analyzer = GitAnalyzer()
impact = analyzer.analyze('.', ref='HEAD', is_remote=False)

print('ðŸ“± Generated Social Media Post:')
print('â”€' * 50)
print(f'ðŸš€ Just pushed updates to {impact.name}!')
print('')
for hook in impact.marketing_hooks[:3]:
    print(f'â€¢ {hook}')
print('')
print(f'ðŸ”— View: https://github.com/theanthonyjin/git-storyteller')
print('â”€' * 50)
"
          echo ""
          echo "âœ… Content generation test passed!"

      - name: Create Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Git-Storyteller Self-Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Type**: ${{ github.event.inputs.test_type || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… All Tests Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Git-Storyteller successfully analyzed itself!" >> $GITHUB_STEP_SUMMARY
